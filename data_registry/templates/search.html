{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load registry %}

{% block script %}
<script>
document.querySelectorAll('.clickable').forEach(div => {
    div.addEventListener('click', event => {
        window.location.href = div.querySelector('.click').href
    })
})

document.querySelectorAll('.filterable').forEach(filter => {
    const key = filter.dataset.key
    const method = filter.dataset.method
    filter.querySelectorAll('input').forEach(input => {
        input.addEventListener('change', event => {
            let url = new URL(window.location.href)
            let params = new URLSearchParams(url.search)
            let values = params.getAll(key)
            if (values.includes(input.value)) {
                // URLSearchParams has no method to delete a key-value pair, and set() yields "x=a,b" not "x=a&x=b".
                params.delete(key)
                values.forEach(value => {
                    if (value != input.value) {
                        params.append(key, value)
                    }
                })
            } else {
                params[method](key, input.value)
            }
            url.search = params.toString()
            window.location.href = url.toString()
        })
    })
})
</script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col">
        <a href="{% url 'index' %}" class="d-flex align-items-center text-uppercase link-dark small">
            {% include "includes/chevron_icon.html" with direction="left" classes="me-2" only %}
            {% translate "BACK TO REGISTRY HOME" %}
        </a>
    </div>
</div>

<div class="row mt-5">
    <div class="col-md-3 col-xl-2 mb-5">
        <h2 class="h4">{% translate "Filters" %}</h2>

        <div class="d-none d-md-block" id="filters">
            <a rel="nofollow" href="?" class="{% if request.GET %}d-block{% else %}d-none{% endif %} mt-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="bi b-iconstack b-icon" width="1em" height="1em" viewBox="0 0 16 16" role="img" focusable="false" fill="currentColor">
                    <g>
                        {# https://icons.getbootstrap.com/icons/slash/ #}
                        <svg class="bi bi-slash b-icon slash" viewBox="0 0 16 16" role="img" focusable="false" fill="currentColor">
                            <g transform="translate(8 8) scale(1.6 1.6) rotate(90) translate(-8 -8)">
                                <path d="M11.354 4.646a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708l6-6a.5.5 0 0 1 .708 0z"/>
                            </g>
                        </svg>
                        {# https://icons.getbootstrap.com/icons/funnel/ #}
                        <svg class="bi bi-funnel b-icon funnel" viewBox="0 0 16 16" role="img" focusable="false" fill="currentColor">
                            <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2zm1 .5v1.308l4.372 4.858A.5.5 0 0 1 7 8.5v5.306l2-.666V8.5a.5.5 0 0 1 .128-.334L13.5 3.308V2h-11z"/>
                        </svg>
                    </g>
                </svg>
                {% translate "Clear all filters" %}
            </a>

            <h3 class="h5 mt-4">{% translate "Country starting with" %}</h3>
            <ul class="list-inline letters">
{% for letter in facets.letters %}
                <li class="list-inline-item mb-1 me-0 text-center">
    {% if facets.letters|get_item:letter %}
                    <a rel="nofollow" href="?{% if letter == request.GET|get_item:'letter' %}{% remove_query_string_parameter 'letter' %}{% else %}{% replace_query_string_parameter 'letter' letter %}{% endif %}" title="{% blocktranslate count counter=facets.letters|get_item:letter %}1 dataset{% plural %}{{ counter }} datasets{% endblocktranslate %}" class="d-inline-block text-decoration-underline{% if letter == request.GET|get_item:'letter' %} bg-primary bg-opacity-25 fw-bold{% elif facets.letters|get_item:letter %} border border-secondary{% endif %}">
                        {{ letter }}
                    </a>
    {% else %}
                    <span class="d-inline-block">{{ letter }}</span>
    {% endif %}
                </li>
{% endfor %}
            </ul>

            {% capture content %}
            {% endcapture %}
            {% include "includes/radiobuttons.html" with title=_("Data date range") key="date_range" items=date_ranges.items facet_counts=facets.date_ranges content=content %}
            {% include "includes/checkboxes.html" with title=_("Update frequency") key="update_frequency" items=frequencies facet_counts=facets.frequencies %}
            {% include "includes/checkboxes.html" with title=_("Data contains") key="counts" items=counts.items facet_counts=facets.counts %}
        </div>
    </div>

    <div class="col-md-9 col-xl-10">
        <h1 class="h4">
{% if request.GET %}
            {% blocktranslate count counter=collections|length trimmed %}
            {{ counter }} dataset matches the selected filters
            {% plural %}
            {{ counter }} datasets match the selected filters
            {% endblocktranslate %}
{% else %}
            {% blocktranslate with counter=collections|length trimmed %}
            Showing all {{ counter }} datasets
            {% endblocktranslate %}
{% endif %}
{% if request.user.is_authenticated %}
            (You are logged in)
{% endif %}
        </h1>

{% for collection in collections %}
        <div class="mt-4 px-3 px-md-5 py-3 rounded-2 rounded-top-start-md rounded-bottom-end-md text-bg-light clickable">
            <div class="row">
                <div class="col-md mb-3 pt-md-2 fixed-9">
    {% if collection.country_flag %}
                    <img src="{% static 'img/flags/' %}{{ collection.country_flag }}" width="114" height="76" alt="" loading="lazy">
    {% endif %}
                </div>
                <div class="col-md">
                    <h2>{{ collection.country }}: {{ collection.title }}</h2>
                    {{ collection.description|markdownify }}
                </div>
            </div>
            <div class="row">
                <div class="col-md">
                    <dl class="mb-0 mb-md-n2 list-desc-inline">
                        <dt>{% translate "Data date range:" %}</dt>
                        <dd>{{ collection.date_from|date:"M Y" }} - {{ collection.date_to|date:"M Y" }}</dd>
                        <dt>{% translate "Update frequency:" %}</dt>
                        <dd>{{ collection.get_update_frequency_display }}</dd>
                        <dt>{% translate "Last retrieved:" %}</dt>
                        <dd>{{ collection.last_update|date:"M Y" }}</dd>
                    </dl>
                </div>
                <div class="col-md-auto col-lg">
                    <p class="mb-2 fw-light">{% translate "Available formats:" %}</p>
                    <ul class="mb-2 list-inline">
                        <li class="list-inline-item text-uppercase">
                            {% include "includes/check_icon.html" with checked=collection.files.jsonl.years only %}JSON
                        </li>
                        <li class="list-inline-item text-uppercase">
                            {% include "includes/check_icon.html" with checked=collection.files.xlsx.years only %}Excel
                        </li>
                        <li class="list-inline-item text-uppercase">
                            {% include "includes/check_icon.html" with checked=collection.files.csv.years only %}CSV
                        </li>
                    </ul>
                    <a href="{% url 'detail' collection.id %}" class="d-flex align-items-center justify-content-end link-primary click">
                        {% include "includes/chevron_icon.html" with direction="right" classes="me-2" only %}
                        {% translate "See details" %}
                    </a>
                </div>
            </div>
        </div>
{% endfor %}
    </div>
</div>
{% endblock %}
