{% extends 'base.html' %}
{% load i18n %}
{% load humanize %}
{% load static %}
{% load vue %}

{% block header %}
    {% include 'header.html' with dark=True %}
{% endblock %}

{% block content %}
    <div id="detail_app" v-cloak>
        <div class="row">
            <div class="col col-auto">
                <a href="{% url 'search' %}" class="link-back">
                    <chevron-btn class="mr-2 icon"></chevron-btn>
                    <span>{% translate "BACK TO DATASETS SEARCH" %}</span>
                </a>
            </div>
        </div>

        <div class="row header-row">
            <div class="col-auto">
                <div class="flag">
                    <img v-if="data.country_flag" :src="`{% static 'img/flags/' %}${data.country_flag}`">
                </div>
            </div>
            <div class="col">
                <h2>[[ data.country ]] [[ data.title ]] <span class="badge badge-pill collection-badge">{% translate "OCDS" %}</span></h2>
                <p class="description" v-html="data.description"></p>
                <template v-if="data.description_long">
                    <p class="description-long" v-if="descriptionExpanded" v-html="data.description_long"></p>
                    <button
                        class="btn btn-link text-info description-long-btn"
                        @click="() => descriptionExpanded = !descriptionExpanded">
                        <template v-if="descriptionExpanded">{% translate "Show less" %}</template>
                        <template v-else>{% translate "Show more" %}</template>
                    </button>
                </template>
            </div>
            <div class="col">
                <div class="label">{% translate "Available formats:" %}</div>
                <div class="formats">
                    <span class="format-json mr-4">
                        <check-icon :checked="data.json_format" class="mr-2"></check-icon>
                        <span>JSON</span>
                    </span>
                    <span class="format-excel">
                        <check-icon :checked="data.excel_format" class="mr-2"></check-icon>
                        <span>EXCEL</span>
                    </span>
                </div>
            </div>
            <div class="col-auto">
                <a class="btn btn-primary btn-md access-btn" href="#access">
                    <chevron-btn class="mr-4 icon" right></chevron-btn>{% translate "ACCESS" %}
                </a>
            </div>
        </div>

        <div class="row detail-section overview">
            <div class="col-3 label">
                <h4>{% translate "Overview" %}</h4>
            </div>
            <div class="col-9 data">
                <div>
                    <span class="label">{% translate "Data date range:" %}</span>
                    <span class="value">[[ data.date_from | moment("MMM YYYY") ]] - [[ data.date_to | moment("MMM YYYY") ]]</span>
                </div>
                <div>
                    <span class="label">{% translate "Last updated:" %}</span>
                    <span class="value">[[ data.last_update | moment("MMM YYYY") ]]</span>
                </div>
                <div>
                    <span class="label">{% translate "Update frequency:" %}</span>
                    <span class="value">
                        <template v-if="data.update_frequency == 'MONTHLY'">{% translate "Monthly" %}</template>
                        <template v-else-if="data.update_frequency == 'HALF_YEARLY'">{% translate "Every 6 months" %}</template>
                        <template v-else-if="data.update_frequency == 'ANNUALLY'">{% translate "Annually" %}</template>
                    </span>
                </div>
                <div>
                    <span class="label">{% translate "OCID prefix:" %}</span>
                    <span class="value">[[ data.ocid_prefix ]]</span>
                </div>
                <div class="license">
                    <span class="label">{% translate "License:" %}</span>
                    <span class="value">
                        <template v-if="data.license_custom">
                            <a :href="data.license_custom.url" target="_blank">[[ data.license_custom.name ]]</a>
                            <div class="small" v-html="data.license_custom.description"></div>
                        </template>
                        <template v-else>[[ data.license ]]</template>
                    </span>
                </div>
                <div>
                    <span class="label">{% translate "Language:" %}</span>
                    <span class="value">[[ data.language ]]</span>
                </div>
            </div>
        </div>

        <div class="row detail-section data">
            <div class="col-3 label">
                <h4>{% translate "Data avaliable" %}</h4>
            </div>
            <div class="col-9">
                <div class="row">
                    <div class="col-4 item">
                        <h6><check-icon :checked="data.parties_count" class="mr-2"></check-icon>{% translate "Parties" %}</h6>
                        <div>{% translate "Count of parties:" %} [[ data.parties_count ]]</div>
                    </div>
                    <div class="col-4 item">
                        <h6><check-icon :checked="data.plannings_count" class="mr-2"></check-icon>{% translate "Plannings" %}</h6>
                        <div>{% translate "Count of planning activities:" %} [[ data.plannings_count ]]</div>
                    </div>
                    <div class="col-4 item">
                        <h6><check-icon :checked="data.tenders_count" class="mr-2"></check-icon>{% translate "Tenders" %}</h6>
                        <div>{% translate "Count of tenders:" %} [[ data.tenders_count ]]</div>
                        <div>{% translate "Count of tenderers:" %} [[ data.tenderers_count ]]</div>
                        <div>{% translate "Count of tender items:" %} [[ data.tenders_items_count ]]</div>
                    </div>
                    <div class="col-4 item">
                        <h6><check-icon :checked="data.awards_count" class="mr-2"></check-icon>{% translate "Awards" %}</h6>
                        <div>{% translate "Count of awards:" %} [[ data.awards_count ]]</div>
                        <div>{% translate "Count of award items:" %} [[ data.awards_items_count ]]</div>
                        <div>{% translate "Count of award suppliers:" %} [[ data.awards_suppliers_count ]]</div>
                    </div>
                    <div class="col-4 item">
                        <h6><check-icon :checked="data.contracts_count" class="mr-2"></check-icon>{% translate "Contracts" %}</h6>
                        <div>{% translate "Count of contracts:" %} [[ data.contracts_count ]]</div>
                        <div>{% translate "Count of contract items:" %} [[ data.contracts_items_count ]]</div>
                        <div>{% translate "Count of contract transactions:" %} [[ data.contracts_transactions_count ]]</div>
                    </div>
                    <div class="col-4 item">
                        <h6><check-icon :checked="data.documents_count" class="mr-2"></check-icon>{% translate "Documents" %}</h6>
                        <div>{% translate "Count of documents:" %} [[ data.documents_count ]]</div>
                    </div>
                    <div class="col-4 item">
                        <h6><check-icon :checked="data.milestones_count" class="mr-2"></check-icon>{% translate "Milestones" %}</h6>
                        <div>{% translate "Count of milestones:" %} [[ data.milestones_count ]]</div>
                    </div>
                    <div class="col-4 item">
                        <h6><check-icon :checked="data.amendments_count" class="mr-2"></check-icon>{% translate "Amendments" %}</h6>
                        <div>{% translate "Count of amendments:" %} [[ data.amendments_count ]]</div>
                    </div>
                </div>

                <div class="row" v-if="data.additional_data">
                    <div class="col">
                        <div class="additional_data">
                            <b-icon class="diamond-icon" icon="gem" scale="1.5"></b-icon>
                            <div v-html="data.additional_data"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row detail-section quality">
            <div class="col-3 label">
                <h4>{% translate "Data quality" %}</h4>
            </div>
            <div class="col-9">
                <h6>{% translate "Summary" %}</h6>
                <p class="summary" v-html="data.summary"></p>

                <template v-if="data.issues">
                    <h6>{% translate "Issues found" %}</h6>

                    <div v-for="n in data.issues" class="issue">
                        <b-icon icon="exclamation-circle"></b-icon>
                        <span v-html="n"></div>
                    </div>
                </template>
            </div>
        </div>

        <div class="row detail-section">
            <div class="col-12">
                <div id="access" class="info_card round access">
                    <h2>{% translate "Access data" %}</h2>
                    <p>{% translate "Access data from <strong>OCDS Kingfisher Collect</strong> database for data range" %}
                        <strong>[[ dateRange ]]</strong>.
                    </p>

                    <div class="row">
                        <div class="col">
                            <h3><check-icon :checked="data.json_format" class="mr-2"></check-icon>{% translate "JSON data" %}</h3>
                            <p class="format-description">
                                {% blocktrans %}
                                This is JSON bulk.
                                {% endblocktrans %}
                            </p>

                            <button class="btn btn-md" v-b-modal.json-export-form>
                                <chevron-btn right></chevron-btn> {% translate "Access JSON data" %}
                            </button>

                            <modal id="json-export-form" title="{% translate 'Access JSON data' %}">
                                <p class="light">
                                    {% blocktrans %}
                                    Please, choose how you would like to access the JSON data. You can either download the full history as one dataset
                                    or choose particular year that you are interested in.
                                    {% endblocktrans %}
                                </p>

                                <div class="subtitle">
                                    <b-radio value="full" v-model="jsonType" id="json-full" size="lg" inline>
                                        {% translate "Full history dataset" %}
                                    </b-radio>
                                </div>
                                <p class="light indention">
                                    {% blocktrans %}
                                    Dataset containing the full history of available data for given source. Depending on the source, the file may be
                                    extremely large and might take some time process.
                                    {% endblocktrans %}
                                </p>

                                <div class="subtitle">
                                    <b-radio value="annual" v-model="jsonType" id="json-annual" size="lg" inline>
                                        {% translate "Particular year dataset" %}
                                    </b-radio>
                                </div>
                                <p class="light indention">
                                    {% blocktrans %}
                                    Dataset containing the full history of available data for given source. Depending on the source, the file may be
                                    extremely large and might take some time process.
                                    {% endblocktrans %}
                                </p>

                                <dropdown
                                    v-model="jsonYear"
                                    :options="jsonYearOptions"
                                    class="indention"
                                    placeholder="{% translate 'Choose year' %}"
                                >
                                </dropdown>

                                <template #modal-footer>
                                    <div>
                                        <button
                                            class="btn"
                                            @click="submitJsonDownload"
                                            :disabled="jsonDownloadBusy || (jsonType === 'annual' && !jsonYear)"
                                        >
                                            <chevron-btn right class="mr-3"></chevron-btn> {% translate "Download data" %}
                                        </button>
                                    </div>
                                </template>
                            </modal>
                        </div>
                        <div class="col">
                            <h3><check-icon :checked="data.excel_format" class="mr-2"></check-icon>{% translate "Excel data via OCP Flatten tool" %}</h3>
                            <p class="format-description">
                                {% blocktrans %}
                                This is Excel bulk.
                                {% endblocktrans %}
                            </p>
                            <button class="btn btn-md">
                                <chevron-btn right></chevron-btn> {% translate "Access Excel data" %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="info_card round helpdesk">
                    <div><b-icon icon="question-circle" scale="1.5" class="mr-3"></b-icon> {% translate "Have questions, feedback on this dataset or content on this page?" %}</div>

                    <button v-b-modal.feedback-form>
                        <chevron-btn right class="mr-3"></chevron-btn> {% translate "Contact OCP helpdesk" %}
                    </button>

                    <modal id="feedback-form" @hidden="feedbackSent = false" :content-class="{centered: feedbackSent}">
                        <template v-if="feedbackSent" #default>
                            {% blocktrans %}
                            <span class="light">You can also email us at</span>
                            <span>caumnau@open-contracting.org</span><span class="light">. We try to read and respond to all your requests.</span>
                            {% endblocktrans %}
                        </template>
                        <template v-else #default>
                            <p class="light">
                                {% blocktrans %}
                                Our mission is to continually improve the quality of procurement data. We welcome feedback from the users of data and the open data community.
                                {% endblocktrans %}
                            </p>

                            <p class="light">
                                {% blocktrans %}
                                To provide specific feedback on the data source, please complete the form below.
                                {% endblocktrans %}
                            </p>

                            <h3 class="subtitle">{% translate "Type of feedback" %}</h3>
                            <dropdown
                                v-model="feedbackType"
                                :options="feedbackTypeOptions"
                                preselect-first
                            >
                            </dropdown>

                            <h3 class="subtitle">{% translate "Please provide your feedback in more detail below" %}</h3>
                            <textarea v-model="feedback" rows="10">
                            </textarea>
                        </template>

                        <template v-if="feedbackSent" #modal-footer="{ close }">
                            <button class="btn btn-close" @click="close">
                                <chevron-btn right class="mr-3"></chevron-btn> {% translate "Close" %}
                            </button>
                        </template>
                        <template v-else #modal-footer>
                            <div>
                                {% blocktrans %}
                                <span class="light">You can also email us at</span>
                                <span>caumnau@open-contracting.org</span><span class="light">. We try to read and respond to all your requests.</span>
                                {% endblocktrans %}
                            </div>
                            <div>
                                <button class="btn btn-submit" @click="submitFeedback" :disabled="!feedback || !feedbackType">
                                    <chevron-btn right class="mr-3"></chevron-btn> {% translate "Submit feedback" %}
                                </button>
                            </div>
                        </template>

                        <template v-if="feedbackSent" #modal-title>
                            <check-icon></check-icon>{% translate "Thanks for your feedback!" %}
                        </template>
                        <template v-else #modal-title>
                            {% trans "Send feedback for" %} "[[ data.title ]]"
                        </template>
                    </modal>
                </div>
            </div>
        </div>
    </div>

    {% chevron_btn_vue_template %}

    {% check_icon_vue_template %}

    {% dropdown_vue_template %}

    {% modal_vue_template %}

    {{ data|json_script:"detail-data" }}

    <script type="text/javascript">
        const DATA = JSON.parse(document.getElementById('detail-data').textContent)

        const FEEDBACK_TYPE_OPTIONS = [
            '{% trans "Broken link" %}',
            '{% trans "Incorrect metadata" %}',
            '{% trans "New data quality issue found" %}',
            '{% trans "Advice for users of this data source" %}',
            '{% trans "Other" %}',
        ]

        const JSON_YEAR_OPTIONS = JSON.parse("{{ export_years }}")

        const EXPORTER_HOST = "{{ exporter_host }}"
    </script>
{% endblock %}