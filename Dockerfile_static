# https://cli.vuejs.org/guide/deployment.html#docker-nginx
FROM node:16 as build-stage-vue
WORKDIR /workdir/data_registry/vue
COPY data_registry/vue/package*.json ./
RUN npm install
COPY data_registry/vue .
RUN npm run build

FROM python:3.8 as build-stage-django

COPY requirements.txt /tmp/requirements.txt
RUN pip install --no-cache-dir -r /tmp/requirements.txt

WORKDIR /workdir
COPY . .

ENV DJANGO_ENV=production

RUN python manage.py collectstatic --noinput

FROM nginxinc/nginx-unprivileged:latest as production-stage
USER root
# Destination of `npm run build` above is set by outputPath in data_registry/vue/webpack.common.js.
COPY --chown=nginx:root --from=build-stage-vue /workdir/static /usr/share/nginx/html/static
# Destination of `manage.py collectstatic` above is set by STATIC_ROOT in core/settings.py.
COPY --chown=nginx:root --from=build-stage-django /workdir/static /usr/share/nginx/html/static
USER nginx
