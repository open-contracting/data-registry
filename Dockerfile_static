# vue statics
FROM node:16-alpine as build-stage-vue

WORKDIR /usr/src/app/data_registry

COPY /data_registry/vue/package*.json ./

RUN npm install

COPY /data_registry/vue .

RUN npm run build

# django statics
FROM python:3.8 as build-stage-django

WORKDIR /app

COPY requirements.txt .

RUN pip install -r requirements.txt

COPY . .

RUN python manage.py collectstatic --noinput --settings=core.settings.docker

# production stage as non-root user
FROM nginxinc/nginx-unprivileged:latest as production-stage

USER root

COPY --from=build-stage-vue /usr/src/app/static /usr/share/nginx/html/static
COPY --from=build-stage-django /app/data_registry/static /usr/share/nginx/html/static

RUN chown -R nginx /usr/share/nginx/html/static/
RUN chmod -R 664 /usr/share/nginx/html/static && chmod -R a+X /usr/share/nginx/html/static

USER nginx

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
